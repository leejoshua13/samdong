<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>No.2 - 창지족-2 지도</title>
  <!-- 네이버 지도 API -->
  <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=wer9y0rp81"></script>
  <style>
    .container { max-width:700px; margin:0 auto; padding:0 16px; box-sizing:border-box; }
    body { font-family:Arial, sans-serif; margin:20px 0; padding-bottom:100px; }
    h2 { margin-top:0; }
    #map { width:100%; height:600px; margin-bottom:20px; border-radius:8px; overflow:hidden; }
    input, button, textarea { width:100%; padding:8px; margin:8px 0; box-sizing:border-box; font-size:1rem; }
    textarea { resize:vertical; height:100px; }
    .label-marker { font-size:16px; font-weight:bold; color:red; background:none; border:none; text-align:center; }
    .bottom-nav { position:fixed; bottom:0; left:0; width:100%; background:#f9f9f9; border-top:1px solid #ddd; display:flex; justify-content:space-around; padding:10px 0; }
    .bottom-nav button { width:45%; padding:10px; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>

  <div class="container">
    <h2>No.2 - 창지족-2</h2>
    <div id="map"></div>

    <label>시작 날짜:
      <input type="date" id="start-date">
    </label>

    <label>종료 날짜:
      <input type="date" id="end-date">
    </label>

    <label>담당자:
      <input type="text" id="person-name" placeholder="이름 입력">
    </label>

    <label>메모:
      <textarea id="memo" placeholder="메모를 입력하세요"></textarea>
    </label>

    <button id="save-btn">저장</button>
  </div>

  <div class="bottom-nav">
    <button onclick="location.href='index.html'">홈</button>
    <button onclick="location.href='index.html#records'">기록 확인</button>
  </div>

  <script type="module">
    // Firebase core SDK
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    // Firebase Realtime Database SDK
    import { getDatabase, ref, push } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

    // Firebase 설정 (console에서 복사한 대로)
    const firebaseConfig = {
      apiKey: "AIzaSyDk9fpF-lsGYeuRNcvfaB0cpdANK-mDPSQ",
      authDomain: "sandong-9579a.firebaseapp.com",
      databaseURL: "https://sandong-9579a-default-rtdb.firebaseio.com",
      projectId: "sandong-9579a",
      storageBucket: "sandong-9579a.appspot.com",
      messagingSenderId: "130428062710",
      appId: "1:130428062710:web:002f9d0899f5b7c5cad5d7",
      measurementId: "G-ZR4KD0E55J"
    };

    // Firebase 초기화
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 하위 구역 좌표 정의 (lng, lat)
    const subs = {
      '2-1': [[127.9927582033,34.8375690054],[127.9920726570,34.8364016479],[127.9938018708,34.8359649343], /* ... */],
      '2-2': [[127.9950297149,34.8388959096],[127.9948455382,34.8386607636],[127.9946920577,34.8386439674], /* ... */],
      '2-3': [[127.9924000820,34.8374850266],[127.9910699176,34.8377117778],[127.9908141167,34.8376781851], /* ... */]
    };

    // 네이버 지도 초기화
    const map = new naver.maps.Map('map', { zoom: 16 });
    const bounds = new naver.maps.LatLngBounds();
    Object.entries(subs).forEach(([key, coords]) => {
      const path = coords.map(([lng, lat]) => new naver.maps.LatLng(lat, lng));
      new naver.maps.Polyline({ map, path, strokeColor:'#f00', strokeWeight:2 });
      path.forEach(p => bounds.extend(p));
      const sb = new naver.maps.LatLngBounds(path[0], path[0]);
      path.forEach(p => sb.extend(p));
      new naver.maps.Marker({
        position: sb.getCenter(),
        map,
        icon: {
          content: `<div class="label-marker">${key.split('-')[1]}</div>`,
          anchor: new naver.maps.Point(0, 0)
        }
      });
    });
    map.fitBounds(bounds);
    if (map.getZoom() > 17) map.setZoom(17);

    // 저장 버튼 클릭 시 Realtime DB에 기록 추가
    document.getElementById('save-btn')
      .addEventListener('click', () => {
        const record = {
          zone:       'No.2 - 창지족-2',
          startDate:  document.getElementById('start-date').value,
          endDate:    document.getElementById('end-date').value,
          personName: document.getElementById('person-name').value,
          memo:       document.getElementById('memo').value,
          savedAt:    new Date().toISOString()
        };
        push(ref(db, 'zoneRecords'), record)
          .then(() => {
            alert('기록이 저장되었습니다!');
            location.href = 'index.html#records';
          })
          .catch(err => {
            console.error('저장 중 오류 발생:', err);
            alert('저장에 실패했습니다. 콘솔을 확인하세요.');
          });
      });
  </script>
</body>
</html>
